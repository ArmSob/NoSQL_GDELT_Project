{"paragraphs":[{"text":"%md\n# GDELT Project\n## Raw data download to S3 bucket","user":"anonymous","dateUpdated":"2021-01-20T15:28:06+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062070_-437974031","id":"20200112-094551_1494650104","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:28:06+0000","dateFinished":"2021-01-20T15:28:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:5411","results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>GDELT Project</h1>\n<h2>Raw data download to S3 bucket</h2>\n</div>"}]}},{"text":"import sys.process._\nimport java.net.{URL, HttpURLConnection}\nimport java.nio.file.{Files,StandardCopyOption}\nimport java.io.File\n\nimport org.apache.spark.sql.functions._\nimport org.apache.spark.sql.SQLContext\nimport org.apache.spark.input.PortableDataStream\nimport java.util.zip.ZipInputStream\nimport java.io.BufferedReader\nimport java.io.InputStreamReader\n\nimport com.amazonaws.services.s3.AmazonS3Client\nimport com.amazonaws.auth.BasicAWSCredentials\nimport com.amazonaws.auth.BasicSessionCredentials","user":"anonymous","dateUpdated":"2021-01-20T15:28:08+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062076_-2111177014","id":"20210114-094836_500661568","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:28:08+0000","dateFinished":"2021-01-20T15:28:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5412","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"import sys.process._\nimport java.net.{URL, HttpURLConnection}\nimport java.nio.file.{Files, StandardCopyOption}\nimport java.io.File\nimport org.apache.spark.sql.functions._\nimport org.apache.spark.sql.SQLContext\nimport org.apache.spark.input.PortableDataStream\nimport java.util.zip.ZipInputStream\nimport java.io.BufferedReader\nimport java.io.InputStreamReader\nimport com.amazonaws.services.s3.AmazonS3Client\nimport com.amazonaws.auth.BasicAWSCredentials\nimport com.amazonaws.auth.BasicSessionCredentials\n"}]}},{"text":"// S3 bucket access configuration\n    \nval AWS_ID = \"ASIAZLK42DVGQUJ2XUGH\"\nval AWS_KEY = \"oAtIf3aJUvuZZ5jjSrCk4F/JCntn7IkFslxlQNPr\"\nval AWS_SESSION_TOKEN = \"FwoGZXIvYXdzEMn//////////wEaDJI2IfEieT6F8Q8nmSLTAfKa0FP+B3nzc2S+iK+FKiEOAkAgIHyFu3+9nnK7VMlaINZs5vY9sT0bDd3xr0CiwGqw2U/qQDMynQbvE2SPtFT27126XQgWwzdxqPRf+rMueigS4jKPn41CKl9aw0kbOq1YWfG8ANHIkSqSjsf/OPlvzo+3GXJMJcr++iSjNaKahfFu0SkHpHeIZhvoGnsHYur1xi6oc9gecYPbGyfdsL1P+ikJi7kquEGpLs2Owh4nukhyrdyPnT0z8LEXvypeNDukXCgSZDwZ6HBBKc3JNBghq2ooz5ahgAYyLYF0n6WcOw2T0cvJKH42CCIRIQUcG+6AHtSclEEvthbIP3Y7M8QKpRJdc2D+Wg==\"\n\n@transient val awsClient = new AmazonS3Client(new BasicSessionCredentials(AWS_ID, AWS_KEY, AWS_SESSION_TOKEN))\n\nsc.hadoopConfiguration.set(\"fs.s3a.access.key\", AWS_ID)\nsc.hadoopConfiguration.set(\"fs.s3a.secret.key\", AWS_KEY)\nsc.hadoopConfiguration.set(\"fs.s3a.secret.token\", AWS_SESSION_TOKEN)","user":"anonymous","dateUpdated":"2021-01-20T15:28:52+0000","config":{"tableHide":false,"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"editorHide":false,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062077_344261206","id":"20200112-102836_1663931357","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:28:52+0000","dateFinished":"2021-01-20T15:28:52+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5413","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"warning: there was one deprecation warning; re-run with -deprecation for details\nAWS_ID: String = ASIAZLK42DVGQUJ2XUGH\nAWS_KEY: String = oAtIf3aJUvuZZ5jjSrCk4F/JCntn7IkFslxlQNPr\nAWS_SESSION_TOKEN: String = FwoGZXIvYXdzEMn//////////wEaDJI2IfEieT6F8Q8nmSLTAfKa0FP+B3nzc2S+iK+FKiEOAkAgIHyFu3+9nnK7VMlaINZs5vY9sT0bDd3xr0CiwGqw2U/qQDMynQbvE2SPtFT27126XQgWwzdxqPRf+rMueigS4jKPn41CKl9aw0kbOq1YWfG8ANHIkSqSjsf/OPlvzo+3GXJMJcr++iSjNaKahfFu0SkHpHeIZhvoGnsHYur1xi6oc9gecYPbGyfdsL1P+ikJi7kquEGpLs2Owh4nukhyrdyPnT0z8LEXvypeNDukXCgSZDwZ6HBBKc3JNBghq2ooz5ahgAYyLYF0n6WcOw2T0cvJKH42CCIRIQUcG+6AHtSclEEvthbIP3Y7M8QKpRJdc2D+Wg==\nawsClient: com.amazonaws.services.s3.AmazonS3Client = com.amazonaws.services.s3.AmazonS3Client@50d5b2c5\n"}]}},{"text":"// fileDownloader function\ndef fileDownloader(urlOfFileToDownload: String, fileName: String) = {\n    val url = new URL(urlOfFileToDownload)\n    val connection = url.openConnection().asInstanceOf[HttpURLConnection]\n    connection.setConnectTimeout(5000)\n    connection.setReadTimeout(5000)\n    connection.connect()\n\n    if (connection.getResponseCode >= 400)\n        println(\"error\")\n    else\n        url #> new File(fileName) !!\n    }","user":"anonymous","dateUpdated":"2021-01-20T15:28:54+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062077_1706442698","id":"20200112-100354_934449719","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:28:54+0000","dateFinished":"2021-01-20T15:28:54+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5414","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"warning: there was one feature warning; re-run with -feature for details\nfileDownloader: (urlOfFileToDownload: String, fileName: String)Any\n"}]}},{"text":"// Master files downloads\nfileDownloader(\"http://data.gdeltproject.org/gdeltv2/masterfilelist.txt\", \"/tmp/masterfilelist.txt\")\nfileDownloader(\"http://data.gdeltproject.org/gdeltv2/masterfilelist-translation.txt\", \"/tmp/masterfilelist_translation.txt\")\nawsClient.putObject(\"telecom-gdelt2020\", \"masterfilelist.txt\", new File(\"/tmp/masterfilelist.txt\") )\nawsClient.putObject(\"telecom-gdelt2020\", \"masterfilelist_translation.txt\", new File( \"/tmp/masterfilelist_translation.txt\") )","user":"anonymous","dateUpdated":"2021-01-20T15:28:57+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062078_-1618562527","id":"20200112-100557_1341750775","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:28:57+0000","dateFinished":"2021-01-20T15:29:05+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5415","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"res18: com.amazonaws.services.s3.model.PutObjectResult = com.amazonaws.services.s3.model.PutObjectResult@5d2a02c6\n"}]}},{"text":"object AwsClient{\n    val s3 = new AmazonS3Client(new BasicSessionCredentials(AWS_ID, AWS_KEY, AWS_SESSION_TOKEN))\n}","user":"anonymous","dateUpdated":"2021-01-20T15:29:08+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062078_784524401","id":"20200120-110146_602857232","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:29:08+0000","dateFinished":"2021-01-20T15:29:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5416","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"warning: there was one deprecation warning; re-run with -deprecation for details\ndefined object AwsClient\n"}]}},{"text":"// masterfile.txt > dataframe\r\n// Year 2020\r\n// Removing unavailable files 20201214121500.*.CSV.zip\r\nval df = sqlContext.read.\r\n    option(\"delimiter\",\" \").\r\n    option(\"infer_schema\",\"true\").\r\n    csv(\"s3://telecom-gdelt2020//masterfilelist.txt\").\r\n    withColumnRenamed(\"_c0\",\"size\").\r\n    withColumnRenamed(\"_c1\",\"hash\").\r\n    withColumnRenamed(\"_c2\",\"url\").\r\n    filter(col(\"url\").\r\n    contains(\"/2020\") &&\r\n    not(col(\"url\").\r\n    contains(\"/20201214121500\"))).cache\r\n\r\n// Raw data download\r\ndf.select(\"url\").repartition(200).foreach( r=> {\r\n        val URL = r.getAs[String](0)\r\n        val fileName = r.getAs[String](0).split(\"/\").last\r\n        val dir = \"/tmp/\"\r\n        val localFileName = dir + fileName\r\n        fileDownloader(URL,  localFileName)\r\n        val localFile = new File(localFileName)\r\n        AwsClient.s3.putObject(\"telecom-gdelt2020\", fileName, localFile)\r\n        localFile.delete()\r\n     })","user":"anonymous","dateUpdated":"2021-01-20T15:29:12+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["http://ip-172-31-8-30.ec2.internal:4040/jobs/job?id=8","http://ip-172-31-8-30.ec2.internal:4040/jobs/job?id=9"],"interpreterSettingId":"spark"}},"apps":[],"jobName":"paragraph_1611148062079_-906705476","id":"20210114-100841_1793490823","dateCreated":"2021-01-20T13:07:42+0000","dateStarted":"2021-01-20T15:29:12+0000","dateFinished":"2021-01-20T16:37:26+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5417","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [size: string, hash: string ... 1 more field]\n"}]}},{"text":"// masterfilelist_translation.txt > dataframe\r\n// Year 2020\r\nval df_translation = sqlContext.read.\r\n    option(\"delimiter\",\" \").\r\n    option(\"infer_schema\",\"true\").\r\n    csv(\"s3://telecom-gdelt2020//masterfilelist_translation.txt\").\r\n    withColumnRenamed(\"_c0\",\"size\").\r\n    withColumnRenamed(\"_c1\",\"hash\").\r\n    withColumnRenamed(\"_c2\",\"url\").\r\n    filter(col(\"url\").\r\n    contains(\"/2020\")).cache\r\n\r\n// Raw data download\r\ndf_translation.select(\"url\").repartition(200).foreach( r=> {\r\n        val URL = r.getAs[String](0)\r\n        val fileName = r.getAs[String](0).split(\"/\").last\r\n        val dir = \"/tmp/\"\r\n        val localFileName = dir + fileName\r\n        fileDownloader(URL,  localFileName)\r\n        val localFile = new File(localFileName)\r\n        AwsClient.s3.putObject(\"telecom-gdelt2020\", fileName, localFile)\r\n        localFile.delete()\r\n     })","user":"anonymous","dateUpdated":"2021-01-20T16:38:58+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062080_1512714708","id":"20210114-102527_1072422974","dateCreated":"2021-01-20T13:07:42+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:5418","dateFinished":"2021-01-20T18:15:02+0000","dateStarted":"2021-01-20T16:38:58+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"df_translation: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [size: string, hash: string ... 1 more field]\n"}]},"runtimeInfos":{"jobUrl":{"propertyName":"jobUrl","label":"SPARK JOB","tooltip":"View in Spark web UI","group":"spark","values":["http://ip-172-31-8-30.ec2.internal:4040/jobs/job?id=10","http://ip-172-31-8-30.ec2.internal:4040/jobs/job?id=11"],"interpreterSettingId":"spark"}}},{"user":"anonymous","dateUpdated":"2021-01-20T13:07:42+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611148062081_-734581028","id":"20210119-075640_663373253","dateCreated":"2021-01-20T13:07:42+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:5419"}],"name":"S3_Raw_Data","id":"2FVSF75W1","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}